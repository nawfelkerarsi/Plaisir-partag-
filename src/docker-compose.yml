version: "3.9"

services:
  traefik:
    image: traefik:v2.11
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    environment:
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: ${TRAEFIK_ACME_EMAIL}
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_CASERVER: ${TRAEFIK_ACME_CA_SERVER:-https://acme-v02.api.letsencrypt.org/directory}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${TRAEFIK_DASHBOARD_DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      - "traefik.http.routers.traefik-metrics.rule=Host(`${TRAEFIK_DASHBOARD_DOMAIN}`) && PathPrefix(`/metrics`)"
      - "traefik.http.routers.traefik-metrics.entrypoints=websecure"
      - "traefik.http.routers.traefik-metrics.tls=true"
      - "traefik.http.routers.traefik-metrics.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-metrics.service=prometheus@internal"
      - "traefik.http.routers.traefik-metrics.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_USERS}"
      - "traefik.http.middlewares.no-cache.headers.customResponseHeaders.Cache-Control=no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
      - "traefik.http.middlewares.no-cache.headers.customResponseHeaders.Pragma=no-cache"
      - "traefik.http.middlewares.no-cache.headers.customResponseHeaders.Expires=0"
      - "traefik.http.routers.front.middlewares=no-cache"
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    container_name: frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    networks:
      - web
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.plaisir.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.plaisir.entrypoints=websecure"
      - "traefik.http.routers.plaisir.tls=true"
      - "traefik.http.routers.plaisir.tls.certresolver=letsencrypt"
      - "traefik.http.services.plaisir.loadbalancer.server.port=80"
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: backend
    env_file:
      - .env
    volumes:
      - ./backend/logs:/app/logs
    expose:
      - "5000"
    networks:
      - web
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.plaisir-api.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.plaisir-api.entrypoints=websecure"
      - "traefik.http.routers.plaisir-api.tls=true"
      - "traefik.http.routers.plaisir-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.plaisir-api.loadbalancer.server.port=5000"
    restart: unless-stopped

networks:
  web:
    name: traefik-public
  app:
    name: plaisir-app
    internal: true
