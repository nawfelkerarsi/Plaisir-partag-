version: "3.9"

services:
  traefik:
    image: traefik:v2.11
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    environment:
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: ${TRAEFIK_ACME_EMAIL}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    networks:
      - web
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    container_name: frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    networks:
      - web
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plaisir.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.plaisir.entrypoints=websecure"
      - "traefik.http.routers.plaisir.tls=true"
      - "traefik.http.routers.plaisir.tls.certresolver=letsencrypt"
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: backend
    env_file:
      - .env
    volumes:
      - ./backend/logs:/app/logs
    expose:
      - "5000"
    networks:
      - app
    restart: unless-stopped

networks:
  web:
    name: traefik-public
  app:
    name: plaisir-app
    internal: true
